---
# Disk Cleanup Playbook
# Purpose: Clean up disk space by removing old logs, temp files, cache
# Issue Types: disk_full, disk_space_low, out_of_space
# Risk: Low (only removes non-critical files)
# Tested: 15 successful resolutions

- name: Disk Space Cleanup
  hosts: all
  become: yes
  vars:
    days_to_keep: "{{ cleanup_days | default(7) }}"
    target_free_space_gb: "{{ target_space | default(10) }}"

  tasks:
    - name: Check current disk usage
      shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage_before
      changed_when: false

    - name: Display disk usage before cleanup
      debug:
        msg: "Current disk usage: {{ disk_usage_before.stdout }}%"

    - name: Clean apt cache (Debian/Ubuntu)
      apt:
        autoclean: yes
        autoremove: yes
      when: ansible_os_family == "Debian"
      ignore_errors: yes

    - name: Clean yum cache (RedHat/CentOS)
      command: yum clean all
      when: ansible_os_family == "RedHat"
      ignore_errors: yes

    - name: Find and remove old log files
      find:
        paths:
          - /var/log
          - /tmp
        patterns: "*.log,*.gz,*.old,*.1,*.2"
        age: "{{ days_to_keep }}d"
        recurse: yes
      register: old_files

    - name: Remove old log files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_files.files }}"
      when: old_files.matched > 0
      ignore_errors: yes

    - name: Clean journal logs (systemd)
      command: journalctl --vacuum-time={{ days_to_keep }}d
      register: journal_clean
      changed_when: "'Deleted' in journal_clean.stdout"
      ignore_errors: yes

    - name: Remove core dumps
      shell: rm -f /var/crash/* /core.*
      register: core_cleanup
      changed_when: core_cleanup.rc == 0
      failed_when: false

    - name: Clean tmp directories
      find:
        paths:
          - /tmp
          - /var/tmp
        age: "{{ days_to_keep }}d"
        file_type: any
      register: tmp_files

    - name: Remove old temp files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ tmp_files.files }}"
      when: tmp_files.matched > 0
      ignore_errors: yes

    - name: Truncate large log files
      shell: |
        find /var/log -type f -size +100M -exec truncate -s 50M {} \;
      register: truncate_result
      changed_when: truncate_result.rc == 0
      failed_when: false

    - name: Clean Docker images (if Docker is installed)
      command: docker system prune -af --volumes
      when: ansible_facts.packages is defined and 'docker' in ansible_facts.packages
      ignore_errors: yes

    - name: Wait for filesystem sync
      command: sync
      changed_when: false

    - name: Check disk usage after cleanup
      shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage_after
      changed_when: false

    - name: Calculate space freed
      set_fact:
        space_freed: "{{ disk_usage_before.stdout | int - disk_usage_after.stdout | int }}"

    - name: Log cleanup activity
      lineinfile:
        path: /var/log/ansible-disk-cleanup.log
        line: "{{ ansible_date_time.iso8601 }} - Disk cleanup: {{ disk_usage_before.stdout }}% -> {{ disk_usage_after.stdout }}% (freed {{ space_freed }}%)"
        create: yes
        mode: '0644'

    - name: Display cleanup summary
      debug:
        msg: |
          Disk Cleanup Summary:
          - Usage Before: {{ disk_usage_before.stdout }}%
          - Usage After: {{ disk_usage_after.stdout }}%
          - Space Freed: {{ space_freed }}%
          - Old files removed: {{ old_files.matched | default(0) }}
          - Temp files removed: {{ tmp_files.matched | default(0) }}

    - name: Check if target free space achieved
      assert:
        that:
          - disk_usage_after.stdout | int < 85
        fail_msg: "Disk usage still high ({{ disk_usage_after.stdout }}%). Manual intervention may be required."
        success_msg: "Disk usage is now acceptable ({{ disk_usage_after.stdout }}%)"
      ignore_errors: yes
